<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackFlow Logistics</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        stone: {
                            850: '#1f1c1a',
                        }
                    },
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Import Map for Three.js and Postprocessing -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "postprocessing": "https://esm.sh/postprocessing@6.33.3?external=three"
            }
        }
    </script>

    <style>
        body {
            /* Default to Light Mode colors, override with dark: classes */
            background-color: #f5f5f4; /* stone-100 */
            color: #1c1917; /* stone-900 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        /* Dark Mode Override handled by Tailwind 'dark' class on html */
        .dark body {
            background-color: #0c0a09;
            color: #fafaf9;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e7e5e4; }
        .dark ::-webkit-scrollbar-track { background: #1c1917; }
        
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #44403c; }
        
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        
        /* View Transitions */
        .view-transition {
            transition: all 0.7s ease-in-out;
        }
        
        .view-enter {
            opacity: 1;
            transform: none; 
        }
        
        .view-exit {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        /* Background Container Fixes */
        #gradient-bg {
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Above the Jet, below the content */
            opacity: 1;
            mix-blend-mode: screen; /* Blends nicely with the 3D model */
            transition: opacity 0.5s ease;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Leaflet Overrides */
        .leaflet-container {
            background: #f5f5f4;
            font-family: inherit;
        }
        .dark .leaflet-container {
            background: #1c1917;
        }
        
        .leaflet-control-attribution {
            background: rgba(255,255,255,0.7) !important;
            color: #666 !important;
        }
        .dark .leaflet-control-attribution {
            background: rgba(0,0,0,0.5) !important;
            color: #aaa !important;
        }
        .leaflet-control-attribution a {
            color: #d97706 !important;
        }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app"></div>

    <!-- Background Logic Module -->
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer, RenderPass, EffectPass, BloomEffect, ChromaticAberrationEffect } from 'postprocessing';

        // --- GRID SCAN SHADER ---
        const vert = `
        varying vec2 vUv;
        void main(){
          vUv = uv;
          gl_Position = vec4(position.xy, 0.0, 1.0);
        }
        `;

        const frag = `
        precision highp float;
        uniform vec3 iResolution;
        uniform float iTime;
        uniform vec2 uSkew;
        uniform float uTilt;
        uniform float uYaw;
        uniform float uLineThickness;
        uniform vec3 uLinesColor;
        uniform vec3 uScanColor;
        uniform float uGridScale;
        uniform float uLineStyle;
        uniform float uLineJitter;
        uniform float uScanOpacity;
        uniform float uScanDirection;
        uniform float uNoise;
        uniform float uBloomOpacity;
        uniform float uScanGlow;
        uniform float uScanSoftness;
        uniform float uPhaseTaper;
        uniform float uScanDuration;
        uniform float uScanDelay;
        varying vec2 vUv;

        uniform float uScanStarts[8];
        uniform float uScanCount;

        const int MAX_SCANS = 8;

        float smoother01(float a, float b, float x){
          float t = clamp((x - a) / max(1e-5, (b - a)), 0.0, 1.0);
          return t * t * t * (t * (t * 6.0 - 15.0) + 10.0);
        }

        void mainImage(out vec4 fragColor, in vec2 fragCoord)
        {
            vec2 p = (2.0 * fragCoord - iResolution.xy) / iResolution.y;

            vec3 ro = vec3(0.0);
            vec3 rd = normalize(vec3(p, 2.0));

            float cR = cos(uTilt), sR = sin(uTilt);
            rd.xy = mat2(cR, -sR, sR, cR) * rd.xy;

            float cY = cos(uYaw), sY = sin(uYaw);
            rd.xz = mat2(cY, -sY, sY, cY) * rd.xz;

            vec2 skew = clamp(uSkew, vec2(-0.7), vec2(0.7));
            rd.xy += skew * rd.z;

            vec3 color = vec3(0.0);
            float minT = 1e20;
            float gridScale = max(1e-5, uGridScale);
            float fadeStrength = 2.0;
            vec2 gridUV = vec2(0.0);

            float hitIsY = 1.0;
            for (int i = 0; i < 4; i++)
            {
                float isY = float(i < 2);
                float pos = mix(-0.2, 0.2, float(i)) * isY + mix(-0.5, 0.5, float(i - 2)) * (1.0 - isY);
                float num = pos - (isY * ro.y + (1.0 - isY) * ro.x);
                float den = isY * rd.y + (1.0 - isY) * rd.x;
                float t = num / den;
                vec3 h = ro + rd * t;

                float depthBoost = smoothstep(0.0, 3.0, h.z);
                h.xy += skew * 0.15 * depthBoost;

                bool use = t > 0.0 && t < minT;
                gridUV = use ? mix(h.zy, h.xz, isY) / gridScale : gridUV;
                minT = use ? t : minT;
                hitIsY = use ? isY : hitIsY;
            }

            vec3 hit = ro + rd * minT;
            float dist = length(hit - ro);

            float jitterAmt = clamp(uLineJitter, 0.0, 1.0);
            if (jitterAmt > 0.0) {
                vec2 j = vec2(
                  sin(gridUV.y * 2.7 + iTime * 1.8),
                  cos(gridUV.x * 2.3 - iTime * 1.6)
                ) * (0.15 * jitterAmt);
                gridUV += j;
            }
            float fx = fract(gridUV.x);
            float fy = fract(gridUV.y);
            float ax = min(fx, 1.0 - fx);
            float ay = min(fy, 1.0 - fy);
            float wx = fwidth(gridUV.x);
            float wy = fwidth(gridUV.y);
            float halfPx = max(0.0, uLineThickness) * 0.5;

            float tx = halfPx * wx;
            float ty = halfPx * wy;

            float aax = wx;
            float aay = wy;

            float lineX = 1.0 - smoothstep(tx, tx + aax, ax);
            float lineY = 1.0 - smoothstep(ty, ty + aay, ay);
            if (uLineStyle > 0.5) {
                float dashRepeat = 4.0;
                float dashDuty = 0.5;
                float vy = fract(gridUV.y * dashRepeat);
                float vx = fract(gridUV.x * dashRepeat);
                float dashMaskY = step(vy, dashDuty);
                float dashMaskX = step(vx, dashDuty);
                if (uLineStyle < 1.5) {
                  lineX *= dashMaskY;
                  lineY *= dashMaskX;
                } else {
                  float dotRepeat = 6.0;
                  float dotWidth = 0.18;
                  float cy = abs(fract(gridUV.y * dotRepeat) - 0.5);
                  float cx = abs(fract(gridUV.x * dotRepeat) - 0.5);
                  float dotMaskY = 1.0 - smoothstep(dotWidth, dotWidth + fwidth(gridUV.y * dotRepeat), cy);
                  float dotMaskX = 1.0 - smoothstep(dotWidth, dotWidth + fwidth(gridUV.x * dotRepeat), cx);
                  lineX *= dotMaskY;
                  lineY *= dotMaskX;
                }
            }
            float primaryMask = max(lineX, lineY);

            vec2 gridUV2 = (hitIsY > 0.5 ? hit.xz : hit.zy) / gridScale;
            if (jitterAmt > 0.0) {
                vec2 j2 = vec2(
                  cos(gridUV2.y * 2.1 - iTime * 1.4),
                  sin(gridUV2.x * 2.5 + iTime * 1.7)
                ) * (0.15 * jitterAmt);
                gridUV2 += j2;
            }
            float fx2 = fract(gridUV2.x);
            float fy2 = fract(gridUV2.y);
            float ax2 = min(fx2, 1.0 - fx2);
            float ay2 = min(fy2, 1.0 - fy2);
            float wx2 = fwidth(gridUV2.x);
            float wy2 = fwidth(gridUV2.y);
            float tx2 = halfPx * wx2;
            float ty2 = halfPx * wy2;
            float aax2 = wx2;
            float aay2 = wy2;
            float lineX2 = 1.0 - smoothstep(tx2, tx2 + aax2, ax2);
            float lineY2 = 1.0 - smoothstep(ty2, ty2 + aay2, ay2);
            if (uLineStyle > 0.5) {
                float dashRepeat2 = 4.0;
                float dashDuty2 = 0.5;
                float vy2m = fract(gridUV2.y * dashRepeat2);
                float vx2m = fract(gridUV2.x * dashRepeat2);
                float dashMaskY2 = step(vy2m, dashDuty2);
                float dashMaskX2 = step(vx2m, dashDuty2);
                if (uLineStyle < 1.5) {
                  lineX2 *= dashMaskY2;
                  lineY2 *= dashMaskX2;
                } else {
                  float dotRepeat2 = 6.0;
                  float dotWidth2 = 0.18;
                  float cy2 = abs(fract(gridUV2.y * dotRepeat2) - 0.5);
                  float cx2 = abs(fract(gridUV2.x * dotRepeat2) - 0.5);
                  float dotMaskY2 = 1.0 - smoothstep(dotWidth2, dotWidth2 + fwidth(gridUV2.y * dotRepeat2), cy2);
                  float dotMaskX2 = 1.0 - smoothstep(dotWidth2, dotWidth2 + fwidth(gridUV2.x * dotRepeat2), cx2);
                  lineX2 *= dotMaskY2;
                  lineY2 *= dotMaskX2;
                }
            }
            float altMask = max(lineX2, lineY2);

            float edgeDistX = min(abs(hit.x - (-0.5)), abs(hit.x - 0.5));
            float edgeDistY = min(abs(hit.y - (-0.2)), abs(hit.y - 0.2));
            float edgeDist = mix(edgeDistY, edgeDistX, hitIsY);
            float edgeGate = 1.0 - smoothstep(gridScale * 0.5, gridScale * 2.0, edgeDist);
            altMask *= edgeGate;

            float lineMask = max(primaryMask, altMask);

            float fade = exp(-dist * fadeStrength);

            float dur = max(0.05, uScanDuration);
            float del = max(0.0, uScanDelay);
            float scanZMax = 2.0;
            float widthScale = max(0.1, uScanGlow);
            float sigma = max(0.001, 0.18 * widthScale * uScanSoftness);
            float sigmaA = sigma * 2.0;

            float combinedPulse = 0.0;
            float combinedAura = 0.0;

            float cycle = dur + del;
            float tCycle = mod(iTime, cycle);
            float scanPhase = clamp((tCycle - del) / dur, 0.0, 1.0);
            float phase = scanPhase;
            if (uScanDirection > 0.5 && uScanDirection < 1.5) {
                phase = 1.0 - phase;
            } else if (uScanDirection > 1.5) {
                float t2 = mod(max(0.0, iTime - del), 2.0 * dur);
                phase = (t2 < dur) ? (t2 / dur) : (1.0 - (t2 - dur) / dur);
            }
            float scanZ = phase * scanZMax;
            float dz = abs(hit.z - scanZ);
            float lineBand = exp(-0.5 * (dz * dz) / (sigma * sigma));
            float taper = clamp(uPhaseTaper, 0.0, 0.49);
            float headW = taper;
            float tailW = taper;
            float headFade = smoother01(0.0, headW, phase);
            float tailFade = 1.0 - smoother01(1.0 - tailW, 1.0, phase);
            float phaseWindow = headFade * tailFade;
            float pulseBase = lineBand * phaseWindow;
            combinedPulse += pulseBase * clamp(uScanOpacity, 0.0, 1.0);
            float auraBand = exp(-0.5 * (dz * dz) / (sigmaA * sigmaA));
            combinedAura += (auraBand * 0.25) * phaseWindow * clamp(uScanOpacity, 0.0, 1.0);

            for (int i = 0; i < MAX_SCANS; i++) {
                if (float(i) >= uScanCount) break;
                float tActiveI = iTime - uScanStarts[i];
                float phaseI = clamp(tActiveI / dur, 0.0, 1.0);
                if (uScanDirection > 0.5 && uScanDirection < 1.5) {
                  phaseI = 1.0 - phaseI;
                } else if (uScanDirection > 1.5) {
                  phaseI = (phaseI < 0.5) ? (phaseI * 2.0) : (1.0 - (phaseI - 0.5) * 2.0);
                }
                float scanZI = phaseI * scanZMax;
                float dzI = abs(hit.z - scanZI);
                float lineBandI = exp(-0.5 * (dzI * dzI) / (sigma * sigma));
                float headFadeI = smoother01(0.0, headW, phaseI);
                float tailFadeI = 1.0 - smoother01(1.0 - tailW, 1.0, phaseI);
                float phaseWindowI = headFadeI * tailFadeI;
                combinedPulse += lineBandI * phaseWindowI * clamp(uScanOpacity, 0.0, 1.0);
                float auraBandI = exp(-0.5 * (dzI * dzI) / (sigmaA * sigmaA));
                combinedAura += (auraBandI * 0.25) * phaseWindowI * clamp(uScanOpacity, 0.0, 1.0);
            }

            float lineVis = lineMask;
            vec3 gridCol = uLinesColor * lineVis * fade;
            vec3 scanCol = uScanColor * combinedPulse;
            vec3 scanAura = uScanColor * combinedAura;

            color = gridCol + scanCol + scanAura;

            float n = fract(sin(dot(gl_FragCoord.xy + vec2(iTime * 123.4), vec2(12.9898,78.233))) * 43758.5453123);
            color += (n - 0.5) * uNoise;
            color = clamp(color, 0.0, 1.0);
            float alpha = clamp(max(lineVis, combinedPulse), 0.0, 1.0);
            float gx = 1.0 - smoothstep(tx * 2.0, tx * 2.0 + aax * 2.0, ax);
            float gy = 1.0 - smoothstep(ty * 2.0, ty * 2.0 + aay * 2.0, ay);
            float halo = max(gx, gy) * fade;
            alpha = max(alpha, halo * clamp(uBloomOpacity, 0.0, 1.0));
            fragColor = vec4(color, alpha);
        }

        void main(){
          vec4 c;
          mainImage(c, vUv * iResolution.xy);
          gl_FragColor = c;
        }
        `;

        // Helper Functions
        function srgbColor(hex) {
            const c = new THREE.Color(hex);
            return c.convertSRGBToLinear();
        }

        function smoothDampVec2(current, target, currentVelocity, smoothTime, maxSpeed, deltaTime) {
            const out = current.clone();
            smoothTime = Math.max(0.0001, smoothTime);
            const omega = 2 / smoothTime;
            const x = omega * deltaTime;
            const exp = 1 / (1 + x + 0.48 * x * x + 0.235 * x * x * x);
            let change = current.clone().sub(target);
            const originalTo = target.clone();
            const maxChange = maxSpeed * smoothTime;
            if (change.length() > maxChange) change.setLength(maxChange);
            target = current.clone().sub(change);
            const temp = currentVelocity.clone().addScaledVector(change, omega).multiplyScalar(deltaTime);
            currentVelocity.sub(temp.clone().multiplyScalar(omega));
            currentVelocity.multiplyScalar(exp);
            out.copy(target.clone().add(change.add(temp).multiplyScalar(exp)));
            const origMinusCurrent = originalTo.clone().sub(current);
            const outMinusOrig = out.clone().sub(originalTo);
            if (origMinusCurrent.dot(outMinusOrig) > 0) {
                out.copy(originalTo);
                currentVelocity.set(0, 0);
            }
            return out;
        }

        function smoothDampFloat(current, target, velRef, smoothTime, maxSpeed, deltaTime) {
            smoothTime = Math.max(0.0001, smoothTime);
            const omega = 2 / smoothTime;
            const x = omega * deltaTime;
            const exp = 1 / (1 + x + 0.48 * x * x + 0.235 * x * x * x);
            let change = current - target;
            const originalTo = target;
            const maxChange = maxSpeed * smoothTime;
            change = Math.sign(change) * Math.min(Math.abs(change), maxChange);
            target = current - change;
            const temp = (velRef.v + omega * change) * deltaTime;
            velRef.v = (velRef.v - omega * temp) * exp;
            let out = target + (change + temp) * exp;
            const origMinusCurrent = originalTo - current;
            const outMinusOrig = out - originalTo;
            if (origMinusCurrent * outMinusOrig > 0) {
                out = originalTo;
                velRef.v = 0;
            }
            return { value: out, v: velRef.v };
        }

        // Mount Function
        window.mountGridScan = function(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Config matching request
            const config = {
                sensitivity: 0.55,
                lineThickness: 1,
                linesColor: "#392e4e",
                gridScale: 0.1,
                scanColor: "#FF9FFC",
                scanOpacity: 0.4,
                enablePost: true,
                bloomIntensity: 0.6,
                chromaticAberration: 0.002,
                noiseIntensity: 0.01,
                lineStyle: 'solid',
                lineJitter: 0.0,
                scanDirection: 'pingpong',
                bloomThreshold: 0,
                bloomSmoothing: 0,
                scanGlow: 0.5,
                scanSoftness: 2,
                scanPhaseTaper: 0.9,
                scanDuration: 2.0,
                scanDelay: 0.5, // Reduced delay for immediate visibility
                snapBackDelay: 250
            };

            const s = THREE.MathUtils.clamp(config.sensitivity, 0, 1);
            const skewScale = THREE.MathUtils.lerp(0.06, 0.2, s);
            const tiltScale = THREE.MathUtils.lerp(0.12, 0.3, s);
            const yawScale = THREE.MathUtils.lerp(0.1, 0.28, s);
            const smoothTime = THREE.MathUtils.lerp(0.45, 0.12, s);
            const maxSpeed = Infinity;
            const yBoost = THREE.MathUtils.lerp(1.2, 1.6, s);

            // Three.js Setup
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.NoToneMapping;
            renderer.autoClear = false;
            renderer.setClearColor(0x000000, 0);
            
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            const uniforms = {
                iResolution: {
                    value: new THREE.Vector3(container.clientWidth, container.clientHeight, renderer.getPixelRatio())
                },
                iTime: { value: 0 },
                uSkew: { value: new THREE.Vector2(0, 0) },
                uTilt: { value: 0 },
                uYaw: { value: 0 },
                uLineThickness: { value: config.lineThickness },
                uLinesColor: { value: srgbColor(config.linesColor) },
                uScanColor: { value: srgbColor(config.scanColor) },
                uGridScale: { value: config.gridScale },
                uLineStyle: { value: 0 },
                uLineJitter: { value: config.lineJitter },
                uScanOpacity: { value: config.scanOpacity },
                uNoise: { value: config.noiseIntensity },
                uBloomOpacity: { value: config.bloomIntensity },
                uScanGlow: { value: config.scanGlow },
                uScanSoftness: { value: config.scanSoftness },
                uPhaseTaper: { value: config.scanPhaseTaper },
                uScanDuration: { value: config.scanDuration },
                uScanDelay: { value: config.scanDelay },
                uScanDirection: { value: 2 },
                uScanStarts: { value: new Array(8).fill(0) },
                uScanCount: { value: 0 }
            };

            const material = new THREE.ShaderMaterial({
                uniforms,
                vertexShader: vert,
                fragmentShader: frag,
                transparent: true,
                depthWrite: false,
                depthTest: false
            });

            const scene = new THREE.Scene();
            const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            const quad = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material);
            scene.add(quad);

            // Post Processing
            let composer = null;
            if (config.enablePost) {
                try {
                    composer = new EffectComposer(renderer);
                    const renderPass = new RenderPass(scene, camera);
                    composer.addPass(renderPass);

                    const bloom = new BloomEffect({
                        intensity: 1.0,
                        luminanceThreshold: config.bloomThreshold,
                        luminanceSmoothing: config.bloomSmoothing
                    });
                    bloom.blendMode.opacity.value = Math.max(0, config.bloomIntensity);

                    const chroma = new ChromaticAberrationEffect({
                        offset: new THREE.Vector2(config.chromaticAberration, config.chromaticAberration),
                        radialModulation: true,
                        modulationOffset: 0.0
                    });

                    const effectPass = new EffectPass(camera, bloom, chroma);
                    effectPass.renderToScreen = true;
                    composer.addPass(effectPass);
                } catch (e) {
                    console.error("Post-processing failed to initialize:", e);
                    composer = null; // Fallback to standard render
                }
            }

            // Interaction State
            const lookTarget = new THREE.Vector2(0, 0);
            const tiltTarget = { value: 0 };
            const yawTarget = { value: 0 };
            const lookCurrent = new THREE.Vector2(0, 0);
            const lookVel = new THREE.Vector2(0, 0);
            const tiltCurrent = { value: 0 };
            const tiltVel = { v: 0 };
            const yawCurrent = { value: 0 };
            const yawVel = { v: 0 };
            let leaveTimer = null;

            // Event Listeners
            const onMove = (e) => {
                if (leaveTimer) {
                    clearTimeout(leaveTimer);
                    leaveTimer = null;
                }
                const rect = container.getBoundingClientRect();
                const nx = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                const ny = -(((e.clientY - rect.top) / rect.height) * 2 - 1);
                lookTarget.set(nx, ny);
                tiltTarget.value = ny * 0.5;
                yawTarget.value = nx * 0.5;
            };

            const onLeave = () => {
                leaveTimer = setTimeout(() => {
                    lookTarget.set(0, 0);
                    tiltTarget.value = 0;
                    yawTarget.value = 0;
                }, config.snapBackDelay);
            };

            const onResize = () => {
                if (!container) return;
                renderer.setSize(container.clientWidth, container.clientHeight);
                material.uniforms.iResolution.value.set(container.clientWidth, container.clientHeight, renderer.getPixelRatio());
                if (composer) composer.setSize(container.clientWidth, container.clientHeight);
            };

            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseleave', onLeave);
            window.addEventListener('resize', onResize);

            // Animation Loop
            let last = performance.now();
            let rafId;

            const tick = () => {
                const now = performance.now();
                const dt = Math.max(0, Math.min(0.1, (now - last) / 1000));
                last = now;

                const smoothedLook = smoothDampVec2(lookCurrent, lookTarget, lookVel, smoothTime, maxSpeed, dt);
                lookCurrent.copy(smoothedLook);

                const smoothedTilt = smoothDampFloat(tiltCurrent.value, tiltTarget.value, tiltVel, smoothTime, maxSpeed, dt);
                tiltCurrent.value = smoothedTilt.value;

                const smoothedYaw = smoothDampFloat(yawCurrent.value, yawTarget.value, yawVel, smoothTime, maxSpeed, dt);
                yawCurrent.value = smoothedYaw.value;

                const skew = new THREE.Vector2(lookCurrent.x * skewScale, -lookCurrent.y * yBoost * skewScale);
                material.uniforms.uSkew.value.set(skew.x, skew.y);
                material.uniforms.uTilt.value = tiltCurrent.value * tiltScale;
                material.uniforms.uYaw.value = THREE.MathUtils.clamp(yawCurrent.value * yawScale, -0.6, 0.6);
                material.uniforms.iTime.value = now / 1000;

                if (composer) {
                    composer.render(dt);
                } else {
                    renderer.render(scene, camera);
                }

                rafId = requestAnimationFrame(tick);
            };
            
            rafId = requestAnimationFrame(tick);

            // Cleanup
            return () => {
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseleave', onLeave);
                window.removeEventListener('resize', onResize);
                cancelAnimationFrame(rafId);
                if (leaveTimer) clearTimeout(leaveTimer);
                
                material.dispose();
                quad.geometry.dispose();
                if (composer) composer.dispose();
                renderer.dispose();
                if (container.contains(renderer.domElement)) {
                    container.removeChild(renderer.domElement);
                }
            };
        };
    </script>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            currentView: 'login',
            theme: 'dark', // 'dark' or 'light'
            isTransitioning: false,
            activeAnimationId: null,
            activeIntervalId: null,
            threeCleanup: null,
            mapCleanup: null,
            isDelayed: false // Simulation state
        };

        // --- NEW: LIVE TRACKING MAP (LEAFLET) ---
        function mountLiveTrackingMap(containerId) {
            const mapContainer = document.getElementById(containerId);
            if (!mapContainer) return;

            // Route coordinates (Sonipat / Rishihood Route)
            const routeCoordinates = [
                { lat: 28.8650, lng: 77.0950 },
                { lat: 28.8750, lng: 77.0920 },
                { lat: 28.8900, lng: 77.0880 },
                { lat: 28.9050, lng: 77.0850 },
                { lat: 28.9250, lng: 77.0800 },
                { lat: 28.9450, lng: 77.0750 },
                { lat: 28.9650, lng: 77.0720 },
                { lat: 28.9800, lng: 77.0700 },
                { lat: 28.9950, lng: 77.0680 },
                { lat: 29.0066, lng: 77.0645 },
            ];

            // Initialize Map
            const map = L.map(containerId, {
                center: [28.9350, 77.0800],
                zoom: 11,
                zoomControl: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                dragging: true,
                attributionControl: true,
            });

            // Theme-based Tiles
            const tileUrl = state.theme === 'dark' 
                ? "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
                : "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";

            L.tileLayer(tileUrl, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Route Path
            const routeLatLngs = routeCoordinates.map(c => [c.lat, c.lng]);

            // Shadow
            L.polyline(routeLatLngs, {
                color: "#059669",
                weight: 8,
                opacity: 0.3,
                lineCap: "round",
                lineJoin: "round",
            }).addTo(map);

            // Main Line
            L.polyline(routeLatLngs, {
                color: "#10b981",
                weight: 5,
                opacity: 0.9,
                lineCap: "round",
                lineJoin: "round",
            }).addTo(map);

            // Icons
            const startIcon = L.divIcon({
                className: "start-marker",
                html: `<div style="width:14px;height:14px;background:#6b7280;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.5);"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7],
            });

            const destIcon = L.divIcon({
                className: "dest-marker",
                html: `
                    <div style="display:flex;flex-direction:column;align-items:center;">
                        <div style="width:32px;height:32px;background:#ef4444;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(239,68,68,0.4);border:3px solid white;">
                            <div style="width:8px;height:8px;background:white;border-radius:50%;"></div>
                        </div>
                    </div>
                `,
                iconSize: [32, 40],
                iconAnchor: [16, 40],
            });

            const truckIcon = L.divIcon({
                className: "truck-marker",
                html: `
                    <div style="width:40px;height:40px;background:#d97706;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.5);border:3px solid white; color: white;">
                        <i data-lucide="truck" style="width:20px;height:20px;"></i>
                    </div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
            });

            const warehouseIcon = L.divIcon({
                className: "warehouse-marker",
                html: `
                    <div style="width:32px;height:32px;background:#374151;border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid #9ca3af; color: #d1d5db; box-shadow:0 2px 8px rgba(0,0,0,0.6);">
                        <i data-lucide="warehouse" style="width:16px;height:16px;"></i>
                    </div>
                `,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
            });

            L.marker(routeLatLngs[0], { icon: startIcon }).addTo(map);
            L.marker(routeLatLngs[routeLatLngs.length - 1], { icon: destIcon }).addTo(map);
            L.marker(routeLatLngs[2], { icon: warehouseIcon }).addTo(map);
            L.marker(routeLatLngs[5], { icon: warehouseIcon }).addTo(map);
            
            const truckMarker = L.marker(routeLatLngs[0], { icon: truckIcon }).addTo(map);

            lucide.createIcons();

            let truckIndex = 0;
            const animateTruck = () => {
                if (truckIndex >= routeCoordinates.length - 1) {
                    truckIndex = 0;
                } else {
                    truckIndex++;
                }
                const nextPos = routeCoordinates[truckIndex];
                truckMarker.setLatLng([nextPos.lat, nextPos.lng]);
                map.panTo([nextPos.lat, nextPos.lng], { animate: true, duration: 1.0 });
            };

            // Initial resize fix for Leaflet
            setTimeout(() => { map.invalidateSize(); }, 200);

            const intervalId = setInterval(animateTruck, 2500);
            state.activeIntervalId = intervalId;

            return () => {
                clearInterval(intervalId);
                map.remove();
            };
        }

        // --- COMPONENTS & VIEWS ---

        const Icons = {
            Box: '<i data-lucide="box"></i>', Mail: '<i data-lucide="mail"></i>', Lock: '<i data-lucide="lock"></i>', 
            ArrowRight: '<i data-lucide="arrow-right"></i>', LogOut: '<i data-lucide="log-out"></i>', Menu: '<i data-lucide="menu"></i>',
            Search: '<i data-lucide="search"></i>', Check: '<i data-lucide="check"></i>', Truck: '<i data-lucide="truck"></i>',
            Package: '<i data-lucide="package"></i>', PackageOpen: '<i data-lucide="package-open"></i>', MapPin: '<i data-lucide="map-pin"></i>',
            Globe: '<i data-lucide="globe"></i>', Warehouse: '<i data-lucide="warehouse"></i>', Zap: '<i data-lucide="zap"></i>',
            Thermometer: '<i data-lucide="thermometer"></i>', ShieldCheck: '<i data-lucide="shield-check"></i>', Smartphone: '<i data-lucide="smartphone"></i>',
            Cpu: '<i data-lucide="cpu"></i>', Layers: '<i data-lucide="layers"></i>', Share2: '<i data-lucide="share-2"></i>',
            Droplets: '<i data-lucide="droplets"></i>', Car: '<i data-lucide="car"></i>', LifeBuoy: '<i data-lucide="life-buoy"></i>',
            Phone: '<i data-lucide="phone"></i>', MessageSquare: '<i data-lucide="message-square"></i>', ChevronDown: '<i data-lucide="chevron-down"></i>',
            ChevronUp: '<i data-lucide="chevron-up"></i>', Send: '<i data-lucide="send"></i>', Github: '<i data-lucide="github"></i>', Chrome: '<i data-lucide="chrome"></i>',
            Sun: '<i data-lucide="sun"></i>', Moon: '<i data-lucide="moon"></i>', CheckCircle: '<i data-lucide="check-circle"></i>', AlertTriangle: '<i data-lucide="alert-triangle"></i>'
        };

        const renderNavbar = (activeView) => `
            <nav class="fixed w-full z-50 bg-white/85 dark:bg-[rgba(12,10,9,0.85)] backdrop-blur-md border-b border-stone-200 dark:border-amber-600/10 transition-all duration-300">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-20">
                        <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="navigate('order-confirmed')">
                            <div class="w-10 h-10 rounded-lg bg-amber-600/10 border border-amber-600/20 flex items-center justify-center mr-3 shadow-[0_0_15px_rgba(217,119,6,0.2)] text-amber-600">
                                ${Icons.Box}
                            </div>
                            <div>
                                <span class="font-bold text-xl tracking-tight block leading-none text-stone-900 dark:text-white">Track<span class="text-amber-600">Flow</span></span>
                                <span class="text-[10px] text-stone-500 dark:text-stone-400 uppercase tracking-widest">Global Logistics</span>
                            </div>
                        </div>
                        <div class="hidden md:flex space-x-8 items-center">
                            <button onclick="navigate('order-confirmed')" class="text-sm font-medium transition-colors ${activeView === 'order-confirmed' ? 'text-stone-900 dark:text-white border-b-2 border-amber-600 pb-0.5' : 'text-stone-500 dark:text-stone-400 hover:text-stone-900 dark:hover:text-white'}">
                                Order Confirmed
                            </button>
                            <button onclick="navigate('dashboard')" class="text-sm font-medium transition-colors ${activeView === 'dashboard' ? 'text-stone-900 dark:text-white border-b-2 border-amber-600 pb-0.5' : 'text-stone-500 dark:text-stone-400 hover:text-stone-900 dark:hover:text-white'}">
                                Journey
                            </button>
                            <button onclick="navigate('tracking')" class="text-sm font-medium transition-colors ${activeView === 'tracking' ? 'text-stone-900 dark:text-white border-b-2 border-amber-600 pb-0.5' : 'text-stone-500 dark:text-stone-400 hover:text-stone-900 dark:hover:text-white'}">
                                Live Tracking
                            </button>
                        </div>
                        <div class="hidden md:flex items-center space-x-4">
                            <!-- Delay Simulator (Hackathon Demo Feature) -->
                            <button onclick="toggleDelayState()" class="px-3 py-1.5 text-xs font-mono rounded border ${state.isDelayed ? 'bg-red-500 text-white border-red-600' : 'bg-stone-100 dark:bg-stone-800 text-stone-500 dark:text-stone-400 border-stone-200 dark:border-stone-700'} transition-colors">
                                ${state.isDelayed ? '‚ö†Ô∏è Delay Active' : 'Simulate Delay'}
                            </button>

                            <!-- Theme Toggle -->
                            <button onclick="toggleTheme()" class="p-2 rounded-lg text-stone-500 hover:bg-stone-100 dark:text-stone-400 dark:hover:bg-white/5 transition-colors">
                                ${state.theme === 'dark' ? Icons.Sun : Icons.Moon}
                            </button>
                            
                            <!-- Profile Divider -->
                            <div class="h-8 w-px bg-stone-200 dark:bg-stone-800 mx-2"></div>

                            <!-- Profile Section -->
                            <div class="flex items-center gap-3 cursor-pointer group relative">
                                <div class="text-right hidden lg:block">
                                    <div class="text-sm font-bold text-stone-900 dark:text-white leading-none">Alex Morgan</div>
                                    <div class="text-[10px] text-stone-500 uppercase tracking-wider font-medium mt-1">Logistics Manager</div>
                                </div>
                                <div class="relative">
                                    <div class="w-10 h-10 rounded-full p-0.5 bg-gradient-to-tr from-amber-500 to-amber-700 shadow-md">
                                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=100&q=80" alt="User" class="w-full h-full rounded-full object-cover border-2 border-white dark:border-stone-950">
                                    </div>
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-stone-950 rounded-full"></div>
                                </div>
                                
                                <!-- Dropdown Menu -->
                                <div class="absolute top-full right-0 mt-4 w-48 bg-white dark:bg-stone-900 rounded-xl shadow-xl border border-stone-200 dark:border-stone-800 overflow-hidden opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right scale-95 group-hover:scale-100 z-50">
                                    <div class="px-4 py-3 border-b border-stone-100 dark:border-stone-800">
                                        <p class="text-xs text-stone-500">Signed in as</p>
                                        <p class="text-sm font-bold text-stone-900 dark:text-white truncate">alex@trackflow.com</p>
                                    </div>
                                    <a href="#" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-800 transition-colors">Profile Settings</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-300 hover:bg-stone-50 dark:hover:bg-stone-800 transition-colors">Help Center</a>
                                    <div class="border-t border-stone-100 dark:border-stone-800"></div>
                                    <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center gap-2">
                                        ${Icons.LogOut} Sign out
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="md:hidden text-stone-700 dark:text-white cursor-pointer">${Icons.Menu}</div>
                    </div>
                </div>
            </nav>
        `;

        const renderFooter = () => `
            <footer class="border-t border-stone-200 dark:border-white/5 bg-white/80 dark:bg-stone-900/80 backdrop-blur py-8 relative z-10">
                <div class="max-w-7xl mx-auto px-4 text-center text-stone-500 text-sm">
                    <p>&copy; 2026 TrackFlow Logistics. All rights reserved.</p>
                </div>
            </footer>
        `;

        // VIEWS CONTENT GENERATORS
        const views = {
            login: () => `
                <div id="login-container" class="fixed inset-0 z-50 flex flex-col transition-all duration-700 ease-in-out view-enter">
                    <!-- GridScan Background (Canvas) - z-index 10 to mix with jet -->
                    <div id="gradient-bg"></div>
                    
                    <!-- F35 Embed Layer - z-index 0 to stay behind -->
                    <div class="absolute inset-0 z-0 flex items-center justify-center opacity-40 pointer-events-none overflow-hidden">
                         <div class="sketchfab-embed-wrapper w-full h-full pointer-events-auto"> 
                            <iframe title="F35 fighter Jet" class="w-full h-full opacity-70" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/084369d3fddc480080cfb05364d75a46/embed?autostart=1&ui_controls=0&ui_infos=0&ui_inspector=0&ui_stop=0&ui_watermark=0&transparent=1"> </iframe>
                            <div class="absolute bottom-4 right-4 text-[10px] text-white/20">
                                <a href="https://sketchfab.com/3d-models/f35-fighter-jet-084369d3fddc480080cfb05364d75a46?utm_medium=embed&utm_campaign=share-popup&utm_content=084369d3fddc480080cfb05364d75a46" target="_blank" rel="nofollow" style="font-weight: bold; color: inherit;"> F35 fighter Jet </a> by <a href="https://sketchfab.com/Spentza93?utm_medium=embed&utm_campaign=share-popup&utm_content=084369d3fddc480080cfb05364d75a46" target="_blank" rel="nofollow" style="font-weight: bold; color: inherit;"> Spentza_93 </a>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow flex items-center justify-center p-4 relative z-20 pointer-events-none">
                        <div class="w-full max-w-md pointer-events-auto">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-white dark:bg-stone-800 shadow-xl border border-stone-200 dark:border-stone-700 mb-6 text-amber-600 dark:text-amber-500">
                                    <i data-lucide="package-open" class="w-10 h-10"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-stone-900 dark:text-white tracking-tight drop-shadow-lg">Welcome Back</h2>
                                <p class="text-stone-600 dark:text-stone-300 mt-2 text-sm drop-shadow-md">Enter your credentials to access the dashboard.</p>
                            </div>
                            <form onsubmit="event.preventDefault(); login();" class="space-y-6">
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-stone-600 dark:text-stone-300 uppercase tracking-wider ml-1 drop-shadow-md">Email Address</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-stone-500">${Icons.Mail}</div>
                                        <input type="email" value="alex@trackflow.com" class="w-full bg-white/80 dark:bg-stone-900/80 border border-stone-300 dark:border-stone-600/50 text-stone-900 dark:text-white text-sm rounded-lg focus:ring-amber-600 focus:border-amber-600 block pl-10 p-3 placeholder-stone-500 transition-all focus:bg-white dark:focus:bg-stone-900 focus:border-amber-600/80 backdrop-blur-sm outline-none shadow-sm" required />
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <label class="text-xs font-medium text-stone-600 dark:text-stone-300 uppercase tracking-wider ml-1 drop-shadow-md">Password</label>
                                        <a href="#" class="text-xs text-amber-600 hover:text-amber-400 transition-colors drop-shadow-md">Forgot password?</a>
                                    </div>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-stone-500">${Icons.Lock}</div>
                                        <input type="password" value="password" class="w-full bg-white/80 dark:bg-stone-900/80 border border-stone-300 dark:border-stone-600/50 text-stone-900 dark:text-white text-sm rounded-lg focus:ring-amber-600 focus:border-amber-600 block pl-10 p-3 placeholder-stone-500 transition-all focus:bg-white dark:focus:bg-stone-900 focus:border-amber-600/80 backdrop-blur-sm outline-none shadow-sm" required />
                                    </div>
                                </div>
                                <button type="submit" class="w-full text-white bg-amber-600 hover:bg-amber-500 font-bold rounded-lg text-sm px-5 py-3.5 text-center transition-all shadow-[0_0_20px_rgba(217,119,6,0.3)] hover:shadow-[0_0_30px_rgba(217,119,6,0.5)] flex items-center justify-center group backdrop-blur-sm">
                                    Sign In <span class="ml-2 group-hover:translate-x-1 transition-transform inline-flex">${Icons.ArrowRight}</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `,
            'order-confirmed': () => `
                <div class="view-section relative w-full h-full min-h-screen transition-all duration-700 ease-in-out view-enter bg-stone-50 dark:bg-stone-950">
                    <div id="gradient-bg"></div>
                    ${renderNavbar('order-confirmed')}
                    <main class="flex-grow pt-28 pb-20 px-4 sm:px-6 lg:px-8 relative z-10">
                        <div class="max-w-4xl mx-auto">
                            <!-- Main Success Card -->
                            <div class="text-center mb-10">
                                <div class="w-20 h-20 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mx-auto mb-6">
                                    <svg class="w-10 h-10 text-green-600 dark:text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <h1 class="text-3xl md:text-4xl font-bold text-stone-900 dark:text-white mb-2">Order Confirmed</h1>
                                <p class="text-xl text-stone-600 dark:text-stone-400 font-medium">We're getting your order ready üòä</p>
                                <p class="text-sm text-stone-500 dark:text-stone-500 mt-2 italic">"The best things are worth the wait."</p>
                                <div class="mt-6 inline-flex items-center px-4 py-2 rounded-full bg-white/80 dark:bg-stone-900/80 backdrop-blur-sm border border-stone-200 dark:border-stone-800 text-sm text-stone-600 dark:text-stone-400">
                                    ‚úÖ Your payment is received and your order is securely registered.
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- LEFT COL: Status & Product -->
                                <div class="space-y-6">
                                    <!-- Confidence Meter -->
                                    <div class="bg-white/90 dark:bg-stone-900/90 backdrop-blur-sm p-6 rounded-2xl border border-stone-200 dark:border-stone-800 shadow-sm">
                                        <div class="flex items-center gap-3 mb-4">
                                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                            <h3 class="font-bold text-stone-900 dark:text-white uppercase tracking-wide text-xs">Security Check</h3>
                                        </div>
                                        <div class="space-y-3">
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-500 text-xs font-bold">‚úì</div>
                                                <span class="text-sm font-medium text-stone-700 dark:text-stone-300">Order Safe</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-500 text-xs font-bold">‚úì</div>
                                                <span class="text-sm font-medium text-stone-700 dark:text-stone-300">Seller Confirmed</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <div class="w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-500 text-xs font-bold">‚úì</div>
                                                <span class="text-sm font-medium text-stone-700 dark:text-stone-300">Payment Locked</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Product Info -->
                                    <div class="bg-white/90 dark:bg-stone-900/90 backdrop-blur-sm p-6 rounded-2xl border border-stone-200 dark:border-stone-800 shadow-sm flex items-start gap-4">
                                        <div class="w-16 h-16 bg-stone-100 dark:bg-stone-800 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <img src="https://images.unsplash.com/photo-1618366712010-f4ae9c647dcb?auto=format&fit=crop&w=150&q=80" alt="Headphones" class="w-12 h-12 object-contain mix-blend-multiply dark:mix-blend-normal" />
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-stone-900 dark:text-white">Sony WH-1000XM4</h3>
                                            <p class="text-sm text-stone-500 dark:text-stone-400">Black, Over-Ear ‚Ä¢ Qty: 1</p>
                                            <p class="font-bold text-stone-900 dark:text-white mt-1">‚Çπ2,499</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT COL: Proof & Next Steps -->
                                <div class="space-y-6">
                                    <!-- Proof Block -->
                                    <div class="bg-white/90 dark:bg-stone-900/90 backdrop-blur-sm p-6 rounded-2xl border border-stone-200 dark:border-stone-800 shadow-sm">
                                        <h3 class="font-bold text-stone-900 dark:text-white mb-4">Order Details</h3>
                                        <div class="space-y-4">
                                            <div class="flex justify-between items-center pb-3 border-b border-stone-100 dark:border-stone-800">
                                                <span class="text-sm text-stone-500">Order ID</span>
                                                <span class="font-mono text-sm font-medium text-stone-900 dark:text-white">ORD-2024-7829341</span>
                                            </div>
                                            <div class="flex justify-between items-center pb-3 border-b border-stone-100 dark:border-stone-800">
                                                <span class="text-sm text-stone-500">Amount Paid</span>
                                                <span class="text-sm font-medium text-stone-900 dark:text-white">‚Çπ2,499 via UPI</span>
                                            </div>
                                            <div class="flex items-center gap-2 text-sm text-amber-600 dark:text-amber-500 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg">
                                                <span>üì©</span> Confirmation sent via Email & SMS
                                            </div>
                                        </div>
                                    </div>

                                    <!-- System Message -->
                                    <div class="bg-blue-50/90 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30 text-center backdrop-blur-sm">
                                        <p class="text-sm font-medium text-blue-700 dark:text-blue-400">No action needed from you right now üëç</p>
                                    </div>
                                </div>
                            </div>

                            <!-- What to Expect -->
                            <div class="mt-10 pt-10 border-t border-stone-200 dark:border-stone-800">
                                <h3 class="text-center font-bold text-stone-900 dark:text-white mb-8">What to Expect</h3>
                                <div class="flex justify-between relative">
                                    <!-- Connecting Line -->
                                    <div class="absolute top-3 left-0 w-full h-0.5 bg-stone-200 dark:bg-stone-800 -z-10"></div>
                                    
                                    <div class="flex flex-col items-center gap-2 bg-stone-50 dark:bg-stone-950 px-2">
                                        <div class="w-6 h-6 rounded-full bg-amber-600 text-white flex items-center justify-center text-xs font-bold">1</div>
                                        <div class="text-center">
                                            <div class="font-bold text-sm text-stone-900 dark:text-white">Packing</div>
                                            <div class="text-xs text-stone-500">Today</div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-center gap-2 bg-stone-50 dark:bg-stone-950 px-2 opacity-50">
                                        <div class="w-6 h-6 rounded-full bg-stone-200 dark:bg-stone-800 text-stone-500 flex items-center justify-center text-xs font-bold">2</div>
                                        <div class="text-center">
                                            <div class="font-bold text-sm text-stone-900 dark:text-white">Shipping</div>
                                            <div class="text-xs text-stone-500">1-2 days</div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-center gap-2 bg-stone-50 dark:bg-stone-950 px-2 opacity-50">
                                        <div class="w-6 h-6 rounded-full bg-stone-200 dark:bg-stone-800 text-stone-500 flex items-center justify-center text-xs font-bold">3</div>
                                        <div class="text-center">
                                            <div class="font-bold text-sm text-stone-900 dark:text-white">Delivery</div>
                                            <div class="text-xs text-stone-500">By 22 Jan</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-12 text-center">
                                <button onclick="navigate('dashboard')" class="bg-stone-900 dark:bg-white text-white dark:text-stone-900 font-bold py-3 px-8 rounded-full shadow-lg hover:scale-105 transition-transform">
                                    Track Order Journey
                                </button>
                            </div>
                        </div>
                    </main>
                    ${renderFooter()}
                </div>
            `,
            dashboard: () => {
                // If Delayed State is Active
                if (state.isDelayed) {
                    return `
                    <div class="view-section relative w-full h-full min-h-screen transition-all duration-700 ease-in-out view-enter bg-stone-50 dark:bg-stone-950">
                        <div id="gradient-bg"></div>
                        ${renderNavbar('dashboard')}
                        <main class="flex-grow pt-28 pb-12 px-4 sm:px-6 lg:px-8 relative z-10">
                            <div class="max-w-2xl mx-auto">
                                <div class="bg-red-50/95 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-3xl p-8 mb-8 text-center backdrop-blur-md">
                                    <div class="w-16 h-16 bg-red-100 dark:bg-red-800/30 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 dark:text-red-500">
                                        ${Icons.AlertTriangle}
                                    </div>
                                    <h2 class="text-2xl font-bold text-stone-900 dark:text-white mb-2">Delivery Update</h2>
                                    <p class="text-stone-600 dark:text-stone-300 mb-6">We‚Äôre running late, and we know this can be frustrating. Your order is delayed due to operational reasons.</p>
                                    
                                    <div class="bg-white dark:bg-stone-900 rounded-xl p-4 mb-6 inline-block border border-stone-200 dark:border-stone-800">
                                        <div class="text-xs uppercase tracking-wider text-stone-500 mb-1">New Expected Delivery</div>
                                        <div class="text-xl font-bold text-stone-900 dark:text-white">22 Jan 2026</div>
                                    </div>

                                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                                        <button onclick="navigate('tracking')" class="bg-stone-900 dark:bg-white text-white dark:text-stone-900 font-bold py-3 px-6 rounded-xl">Track Order</button>
                                        <button class="bg-transparent border border-stone-300 dark:border-stone-700 text-stone-700 dark:text-stone-300 font-bold py-3 px-6 rounded-xl hover:bg-stone-100 dark:hover:bg-stone-800">Chat Support</button>
                                    </div>
                                    
                                    <p class="mt-6 text-sm text-stone-500 dark:text-stone-400">We‚Äôre actively working with the seller to fix this.</p>
                                    <button class="mt-2 text-sm text-red-600 dark:text-red-400 hover:underline">Cancel for full refund üí∏</button>
                                </div>
                            </div>
                        </main>
                        ${renderFooter()}
                    </div>
                    `;
                }

                // Normal Journey State
                return `
                <div class="view-section relative w-full h-full min-h-screen transition-all duration-700 ease-in-out view-enter bg-stone-50 dark:bg-stone-950">
                    <div id="gradient-bg"></div>
                    ${renderNavbar('dashboard')}
                    <main class="flex-grow pt-28 pb-12 px-4 sm:px-6 lg:px-8 relative z-10">
                        <div class="max-w-3xl mx-auto">
                            <!-- Header Section -->
                            <div class="mb-10">
                                <h1 class="text-3xl md:text-4xl font-bold text-stone-900 dark:text-white mb-2 tracking-tight">Your Order Journey</h1>
                                <p class="text-stone-500 dark:text-stone-400 text-lg">We‚Äôll keep you updated every step of the way</p>
                            </div>

                            <!-- Info Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
                                <div class="bg-white/90 dark:bg-stone-900/60 p-5 rounded-xl border border-stone-200 dark:border-stone-800 shadow-sm backdrop-blur-sm">
                                    <div class="text-xs font-semibold uppercase tracking-wider text-stone-500 mb-1">Order Placed</div>
                                    <div class="text-lg font-medium text-stone-900 dark:text-white">18 Jan 2026</div>
                                </div>
                                <div class="bg-white/90 dark:bg-stone-900/60 p-5 rounded-xl border border-stone-200 dark:border-stone-800 shadow-sm backdrop-blur-sm">
                                    <div class="text-xs font-semibold uppercase tracking-wider text-stone-500 mb-1">Expected Delivery</div>
                                    <div class="text-lg font-medium text-stone-900 dark:text-white text-green-600 dark:text-green-500">21 Jan 2026</div>
                                </div>
                                <div class="bg-white/90 dark:bg-stone-900/60 p-5 rounded-xl border border-stone-200 dark:border-stone-800 shadow-sm backdrop-blur-sm">
                                    <div class="text-xs font-semibold uppercase tracking-wider text-stone-500 mb-1">Sold By</div>
                                    <div class="text-lg font-medium text-stone-900 dark:text-white">TechWorld Retail</div>
                                    <div class="text-xs text-amber-500 font-bold mt-1">‚≠ê 4.6</div>
                                </div>
                            </div>

                            <!-- Current Status Highlight -->
                            <div class="bg-amber-50/90 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-900/30 rounded-2xl p-6 mb-12 flex items-start gap-4 backdrop-blur-sm">
                                <div class="w-10 h-10 rounded-full bg-amber-100 dark:bg-amber-800/40 flex items-center justify-center flex-shrink-0 text-amber-600 dark:text-amber-500">
                                    ${Icons.PackageOpen}
                                </div>
                                <div>
                                    <h3 class="text-sm font-bold uppercase tracking-wider text-amber-700 dark:text-amber-500 mb-1">What‚Äôs happening now</h3>
                                    <p class="text-lg font-medium text-stone-900 dark:text-white mb-4">The seller received your order and is now packing your items.</p>
                                    <div class="grid grid-cols-2 gap-8 text-sm">
                                        <div><div class="text-stone-500 dark:text-stone-400 mb-0.5">Handled by</div><div class="font-medium text-stone-900 dark:text-white">Seller</div></div>
                                        <div><div class="text-stone-500 dark:text-stone-400 mb-0.5">Typical duration</div><div class="font-medium text-stone-900 dark:text-white">6‚Äì12 hours typically</div></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vertical Story Timeline -->
                            <div class="mb-12 relative pl-4 md:pl-0">
                                <div class="absolute left-8 top-4 bottom-4 w-0.5 bg-stone-200 dark:bg-stone-800 hidden md:block"></div>
                                <div class="space-y-8">
                                    <div class="relative flex md:items-center gap-6">
                                        <div class="hidden md:flex w-16 flex-col items-end pt-1"><div class="text-xs font-mono text-stone-400">05:08 AM</div></div>
                                        <div class="hidden md:flex w-4 h-4 rounded-full bg-green-500 ring-4 ring-white dark:ring-stone-950 z-10 items-center justify-center">
                                            <svg class="w-2.5 h-2.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                        </div>
                                        <div class="flex-1 bg-white/80 dark:bg-stone-900/40 p-4 rounded-lg border border-stone-200 dark:border-stone-800 opacity-70 backdrop-blur-sm">
                                            <h4 class="font-bold text-stone-900 dark:text-white flex items-center gap-2">Order Confirmed <span class="text-green-500 text-xs bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded-full">Complete</span></h4>
                                            <p class="text-sm text-stone-500 dark:text-stone-400 mt-1">Payment verified and locked.</p>
                                        </div>
                                    </div>
                                    <div class="relative flex md:items-center gap-6">
                                        <div class="hidden md:flex w-16 flex-col items-end pt-1"><div class="text-xs font-mono text-amber-600 font-bold">Now</div></div>
                                        <div class="hidden md:flex w-4 h-4 rounded-full bg-amber-500 ring-4 ring-amber-100 dark:ring-amber-900/30 z-10 animate-pulse"></div>
                                        <div class="flex-1 bg-white/90 dark:bg-stone-900 p-5 rounded-lg border border-amber-200 dark:border-amber-900/50 shadow-md backdrop-blur-sm">
                                            <h4 class="font-bold text-stone-900 dark:text-white text-lg">Preparing Your Order</h4>
                                            <p class="text-stone-600 dark:text-stone-300 mt-1">Seller is packing your items.</p>
                                        </div>
                                    </div>
                                    <div class="relative flex md:items-center gap-6 opacity-50">
                                        <div class="hidden md:flex w-16 flex-col items-end pt-1"></div>
                                        <div class="hidden md:flex w-4 h-4 rounded-full bg-stone-200 dark:bg-stone-700 z-10 border-2 border-white dark:border-stone-800"></div>
                                        <div class="flex-1 p-4 rounded-lg border border-transparent">
                                            <h4 class="font-semibold text-stone-700 dark:text-stone-300">On the Move</h4>
                                            <p class="text-sm text-stone-500">Travelling to your city hub.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Live Tracking CTA -->
                            <div class="bg-stone-100/90 dark:bg-stone-900/50 rounded-xl p-6 text-center mb-12 backdrop-blur-sm">
                                <p class="text-sm text-stone-600 dark:text-stone-400 mb-4 flex items-center justify-center gap-2">
                                    <span>üí°</span> Live tracking will appear once your order is out for delivery
                                </p>
                                <button onclick="navigate('tracking')" class="px-6 py-2.5 rounded-lg bg-stone-200 dark:bg-stone-800 text-stone-500 dark:text-stone-400 font-medium text-sm border border-stone-300 dark:border-stone-700 hover:bg-stone-300 dark:hover:bg-stone-700 transition-colors">
                                    View Live Tracking Map (Demo)
                                </button>
                            </div>
                        </div>
                    </main>
                    ${renderFooter()}
                </div>
                `;
            },
            tracking: () => `
                <div class="view-section relative w-full h-full min-h-screen transition-all duration-700 ease-in-out view-enter bg-stone-50 dark:bg-stone-950">
                    ${renderNavbar('tracking')}
                    <main class="flex-grow pt-24 pb-0 relative z-10 h-[calc(100vh-6rem)]">
                        <!-- Tracking Overlay -->
                        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-md bg-white/90 dark:bg-stone-900/90 backdrop-blur-md rounded-2xl p-4 shadow-xl border border-stone-200 dark:border-stone-700">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center text-amber-600 dark:text-amber-500">
                                    ${Icons.Truck}
                                </div>
                                <div>
                                    <h2 class="font-bold text-stone-900 dark:text-white text-sm">Your delivery partner is on the way üö¥‚Äç‚ôÇÔ∏è</h2>
                                    <p class="text-xs text-stone-500 dark:text-stone-400">Sold by TechWorld Retail ‚≠ê 4.6</p>
                                </div>
                            </div>
                        </div>

                        <!-- Map Container -->
                        <div id="full-map-container" class="w-full h-full bg-stone-200 dark:bg-stone-800"></div>
                        
                        <!-- Bottom Action Sheet style overlay -->
                        <div class="absolute bottom-8 left-4 right-4 z-20 md:left-auto md:right-8 md:w-96">
                            <div class="bg-white dark:bg-stone-900 rounded-2xl shadow-2xl p-6 border border-stone-200 dark:border-stone-800">
                                <div class="flex justify-between items-end mb-4">
                                    <div>
                                        <p class="text-xs text-stone-500 uppercase font-bold">Estimated Arrival</p>
                                        <p class="text-2xl font-bold text-stone-900 dark:text-white">15-20 min</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-stone-500">Distance</p>
                                        <p class="font-mono text-stone-900 dark:text-white">5.2 km</p>
                                    </div>
                                </div>
                                <button class="w-full py-3 rounded-xl bg-stone-100 dark:bg-stone-800 text-stone-900 dark:text-white font-bold hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors">Call Partner</button>
                            </div>
                        </div>
                    </main>
                </div>
            `,
            // Keep marketing pages for context
            services: () => `<div class="p-20 text-center text-stone-500">Marketing Page Placeholder</div>`,
            enterprise: () => `<div class="p-20 text-center text-stone-500">Enterprise Page Placeholder</div>`,
            support: () => `<div class="p-20 text-center text-stone-500">Support Page Placeholder</div>`
        };

        // --- APP LOGIC ---

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                state.theme = 'light';
            } else {
                html.classList.add('dark');
                state.theme = 'dark';
            }
            render(state.currentView);
        }

        function toggleDelayState() {
            state.isDelayed = !state.isDelayed;
            render(state.currentView);
        }

        function render(viewName) {
            const app = document.getElementById('app');
            
            if (app.firstElementChild) {
                const currentEl = app.firstElementChild;
                currentEl.classList.remove('view-enter');
                currentEl.classList.add('view-exit');
            }

            // Cleanup
            if (state.threeCleanup) { state.threeCleanup(); state.threeCleanup = null; }
            if (state.mapCleanup) { state.mapCleanup(); state.mapCleanup = null; }

            state.currentView = viewName;

            setTimeout(() => {
                app.innerHTML = views[viewName]();
                lucide.createIcons();
                
                // Init features
                if (viewName === 'login') {
                    // Using new GridScan instead of OGL
                    if(window.mountGridScan) state.threeCleanup = window.mountGridScan('gradient-bg');
                } else if (viewName === 'order-confirmed') {
                    if(window.mountGridScan) state.threeCleanup = window.mountGridScan('gradient-bg');
                } else if (viewName === 'dashboard') {
                    if(window.mountGridScan) state.threeCleanup = window.mountGridScan('gradient-bg');
                } else if (viewName === 'tracking') {
                    state.mapCleanup = mountLiveTrackingMap('full-map-container');
                }
            }, 600); 
        }

        window.login = () => { render('order-confirmed'); };
        window.logout = () => { render('login'); };
        window.navigate = (view) => { if (state.currentView === view) return; render(view); };

        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');
            app.innerHTML = views.login();
            lucide.createIcons();
            // Wait slightly for modules to load if needed, but module script runs deferred usually
            setTimeout(() => {
                if(window.mountGridScan) state.threeCleanup = window.mountGridScan('gradient-bg');
            }, 100);
        });

    </script>
</body>
</html>